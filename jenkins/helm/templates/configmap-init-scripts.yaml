apiVersion: v1
kind: ConfigMap
metadata:
  name: jenkins-init-scripts
  namespace: {{ .Values.jenkins.namespace }}
  labels:
    app: jenkins
    component: init-scripts
data:
  01-create-seed-job.groovy: |
    import jenkins.model.Jenkins

    def jenkins = Jenkins.instance
    def jobName = 'seed-job'

    // Check if job already exists
    def existingJob = jenkins.getItem(jobName)
    if (existingJob != null) {
        println "âœ… Seed job '${jobName}' already exists, skipping creation"
        return
    }

    println "ðŸŒ± Creating seed job '${jobName}' using XML configuration..."

    // Create job from XML
    def xml = '''<?xml version='1.1' encoding='UTF-8'?>
    <project>
      <description>Seed job that creates other Jenkins jobs from inline DSL script</description>
      <keepDependencies>false</keepDependencies>
      <properties/>
      <scm class="hudson.scm.NullSCM"/>
      <canRoam>true</canRoam>
      <disabled>false</disabled>
      <blockBuildWhenDownstreamBuilding>false</blockBuildWhenDownstreamBuilding>
      <blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>
      <triggers/>
      <concurrentBuild>false</concurrentBuild>
      <builders>
    <javaposse.jobdsl.plugin.ExecuteDslScripts>
      <scriptText><![CDATA[
pipelineJob('release-build-job') {
    description('ðŸš€ Release Build Job - Build code, create versioned release, and archive artifacts using Release Plugin')
    displayName('ðŸš€ Release Build Job')
    
    properties {
        buildDiscarder {
            strategy {
                logRotator {
                    daysToKeepStr('30')
                    numToKeepStr('10')
                    artifactDaysToKeepStr('30')
                    artifactNumToKeepStr('10')
                }
            }
        }
    }
    
    parameters {
        choiceParam('APPLICATION', ['app1-node', 'app2-python'], 'Select application to build')
        stringParam('VERSION', '1.0.0', 'Version number for the release (e.g., 1.0.0)')
        booleanParam('DEPLOY_TO_DEV', true, 'Automatically deploy to dev environment after build')
    }
    
    definition {
        cpsScm {
            scm {
                git {
                    remote {
                        url('https://github.com/pkalbande/jenkins-gitops-platform.git')
                        credentials('github-token')
                    }
                    branch('*/master')
                }
            }
            scriptPath('jenkins/pipelines/release-build/Jenkinsfile')
        }
    }
}

pipelineJob('promotion-orchestrator-job') {
    description('ðŸŽ¯ Promotion Orchestrator Job - Select and promote previous builds across environments (DEV â†’ QA â†’ STAGE â†’ PROD)')
    displayName('ðŸŽ¯ Promotion Orchestrator Job')
    
    properties {
        buildDiscarder {
            strategy {
                logRotator {
                    daysToKeepStr('60')
                    numToKeepStr('20')
                    artifactDaysToKeepStr('60')
                    artifactNumToKeepStr('20')
                }
            }
        }
    }
    
    parameters {
        choiceParam('APPLICATION', ['app1-node', 'app2-python'], 'Select application to promote')
        stringParam('BUILD_NUMBER', '', 'Build number from release-build-job to promote')
        stringParam('VERSION', '', 'Version to promote (e.g., 1.0.0)')
        choiceParam('PROMOTION_LEVEL', ['Deploy-to-DEV', 'Deploy-to-QA', 'Deploy-to-STAGE', 'Deploy-to-PROD'], 'Select promotion level')
        textParam('APPROVAL_NOTES', '', 'Approval notes and justification')
    }
    
    definition {
        cpsScm {
            scm {
                git {
                    remote {
                        url('https://github.com/pkalbande/jenkins-gitops-platform.git')
                        credentials('github-token')
                    }
                    branch('*/master')
                }
            }
            scriptPath('jenkins/pipelines/promotion-orchestrator/Jenkinsfile')
        }
    }
}
      ]]></scriptText>
      <usingScriptText>true</usingScriptText>
      <sandbox>false</sandbox>
      <removedJobAction>IGNORE</removedJobAction>
      <removedViewAction>IGNORE</removedViewAction>
      <removedConfigFilesAction>IGNORE</removedConfigFilesAction>
      <lookupStrategy>JENKINS_ROOT</lookupStrategy>
    </javaposse.jobdsl.plugin.ExecuteDslScripts>
  </builders>
      <publishers/>
      <buildWrappers/>
    </project>'''

    // Create job from XML
    def xmlStream = new ByteArrayInputStream(xml.getBytes())
    jenkins.createProjectFromXML(jobName, xmlStream)

    println "âœ… Seed job '${jobName}' created successfully!"
    println "ðŸŽ¯ Jenkins will now execute the DSL script to create other jobs"
