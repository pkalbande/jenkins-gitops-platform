jenkins:
  name: jenkins
  namespace: jenkins
  replicas: 1
  
  image: jenkins/jenkins
  tag: lts-jdk17
  imagePullPolicy: IfNotPresent
  
  serviceAccount: jenkins
  
  javaOpts: "-Xmx1024m -Xms512m -Djenkins.install.runSetupWizard=false"
  
  # Jenkins plugins - will be installed on first boot via install-plugins.txt
  installPlugins: true
  additionalPlugins:
    - release
    - promoted-builds
    - job-dsl
    - workflow-aggregator
  
  resources:
    requests:
      cpu: 750m
      memory: 1536Mi
    limits:
      cpu: 2250m
      memory: 2560Mi
  
  service:
    type: NodePort
    nodePort: 30000
  
  persistence:
    enabled: true
    claimName: jenkins-pvc
    size: 20Gi
    storageClass: local-storage
  
  ingress:
    enabled: false
  
  casc:
    config: |
      jenkins:
        systemMessage: |
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin: 20px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h2 style="margin: 0 0 10px 0; font-size: 24px;">ðŸš€ Jenkins GitOps Platform - LOCAL ENVIRONMENT</h2>
            <p style="margin: 0; font-size: 14px; opacity: 0.9;">
              <strong>Environment:</strong> Local Development | 
              <strong>Managed by:</strong> ArgoCD | 
              <strong>Cluster:</strong> Kind (kind-2) | 
              <strong>Namespace:</strong> jenkins
            </p>
          </div>
        numExecutors: 2
        mode: NORMAL
        securityRealm:
          local:
            allowsSignup: false
            users:
              - id: admin
                password: ${JENKINS_ADMIN_PASSWORD:-admin123}
        authorizationStrategy:
          loggedInUsersCanDoAnything:
            allowAnonymousRead: false
        # Kubernetes cloud configuration commented out - plugin not installed
        # clouds:
        #   - kubernetes:
        #       name: kubernetes
        #       serverUrl: https://kubernetes.default
        #       namespace: jenkins
        #       jenkinsUrl: http://jenkins:8080
        #       jenkinsTunnel: jenkins:50000
        #       containerCapStr: 5
        #       templates:
        #         - name: jnlp-agent
        #           namespace: jenkins
        #           label: jnlp-agent
        #           containers:
        #             - name: jnlp
        #               image: jenkins/inbound-agent:latest
        #               workingDir: /home/jenkins/agent
        #               ttyEnabled: true
        #               resourceRequestCpu: 100m
        #               resourceRequestMemory: 256Mi
        #               resourceLimitCpu: 500m
        #               resourceLimitMemory: 512Mi
      
      jobs:
        - script: >
            freeStyleJob('seed-job') {
              displayName('ðŸŒ± DSL Seed Job')
              description('Seed job that creates other Jenkins jobs from DSL scripts in Git')
              scm {
                git {
                  remote {
                    url('https://github.com/pkalbande/jenkins-gitops-platform.git')
                    credentials('github-token')
                  }
                  branch('*/master')
                }
              }
              steps {
                dsl {
                  external('jenkins/dsl/jobs.groovy')
                  removeAction('IGNORE')
                  removeViewAction('IGNORE')
                  ignoreExisting(false)
                  lookupStrategy('JENKINS_ROOT')
                }
              }
            }
        
        - script: >
            pipelineJob('release-build-job') {
              description('Release Build Job - Build code, create versioned release, and archive artifacts using Release Plugin')
              displayName('ðŸš€ Release Build Job')
              properties {
                buildDiscarder {
                  strategy {
                    logRotator {
                      daysToKeepStr('30')
                      numToKeepStr('10')
                      artifactDaysToKeepStr('30')
                      artifactNumToKeepStr('10')
                    }
                  }
                }
                promotions {
                  promotion {
                    name('Deploy-to-DEV')
                    icon('star-gold')
                    conditions {
                      manual('admin')
                    }
                    actions {
                      shell('''
                        echo "Promoting build ${BUILD_NUMBER} to DEV environment"
                        echo "Application: ${APPLICATION}"
                        echo "Version: ${VERSION}"
                      ''')
                    }
                  }
                  promotion {
                    name('Deploy-to-QA')
                    icon('star-blue')
                    conditions {
                      manual('admin')
                      upstream('Deploy-to-DEV')
                    }
                    actions {
                      shell('''
                        echo "Promoting build ${BUILD_NUMBER} to QA environment"
                        echo "Application: ${APPLICATION}"
                        echo "Version: ${VERSION}"
                      ''')
                    }
                  }
                  promotion {
                    name('Deploy-to-STAGE')
                    icon('star-silver')
                    conditions {
                      manual('admin')
                      upstream('Deploy-to-QA')
                    }
                    actions {
                      shell('''
                        echo "Promoting build ${BUILD_NUMBER} to STAGE environment"
                        echo "Application: ${APPLICATION}"
                        echo "Version: ${VERSION}"
                      ''')
                    }
                  }
                  promotion {
                    name('Deploy-to-PROD')
                    icon('star-red')
                    conditions {
                      manual('admin')
                      upstream('Deploy-to-STAGE')
                    }
                    actions {
                      shell('''
                        echo "Promoting build ${BUILD_NUMBER} to PROD environment"
                        echo "Application: ${APPLICATION}"
                        echo "Version: ${VERSION}"
                        echo "This is the final production deployment"
                      ''')
                    }
                  }
                }
              }
              parameters {
                choiceParam('APPLICATION', ['app1-node', 'app2-python'], 'Select application to build')
                stringParam('VERSION', '1.0.0', 'Version number for the release (e.g., 1.0.0)')
                booleanParam('DEPLOY_TO_DEV', true, 'Automatically deploy to dev environment after build')
              }
              definition {
                cpsScm {
                  scm {
                    git {
                      remote {
                        url('https://github.com/pkalbande/jenkins-gitops-platform.git')
                        credentials('github-token')
                      }
                      branch('*/master')
                    }
                  }
                  scriptPath('jenkins/pipelines/release-build/Jenkinsfile')
                }
              }
            }
        
        - script: >
            pipelineJob('promotion-orchestrator-job') {
              description('Promotion Orchestrator Job - Select and promote previous builds across environments (DEV â†’ QA â†’ STAGE â†’ PROD)')
              displayName('ðŸŽ¯ Promotion Orchestrator Job')
              properties {
                buildDiscarder {
                  strategy {
                    logRotator {
                      numToKeepStr('20')
                    }
                  }
                }
              }
              parameters {
                choiceParam('APPLICATION', ['app1-node', 'app2-python'], 'Select application to promote')
                stringParam('BUILD_NUMBER', '', 'Build number from release-build-job to promote')
                stringParam('VERSION', '', 'Version to promote (e.g., 1.0.0)')
                choiceParam('PROMOTION_LEVEL', ['Deploy-to-DEV', 'Deploy-to-QA', 'Deploy-to-STAGE', 'Deploy-to-PROD'], 'Select promotion level')
                textParam('APPROVAL_NOTES', '', 'Approval notes and justification')
              }
              definition {
                cpsScm {
                  scm {
                    git {
                      remote {
                        url('https://github.com/pkalbande/jenkins-gitops-platform.git')
                        credentials('github-token')
                      }
                      branch('*/master')
                    }
                  }
                  scriptPath('jenkins/pipelines/promotion-orchestrator/Jenkinsfile')
                }
              }
            }
      
      unclassified:
        location:
          url: http://localhost:30000
      
      credentials:
        system:
          domainCredentials:
            - credentials:
                - string:
                    scope: GLOBAL
                    id: github-token
                    secret: ${GITHUB_TOKEN}
                    description: GitHub Personal Access Token
                - usernamePassword:
                    scope: GLOBAL
                    id: docker-registry
                    username: ${DOCKER_USERNAME:-admin}
                    password: ${DOCKER_PASSWORD:-admin}
                    description: Docker Registry Credentials
                - string:
                    scope: GLOBAL
                    id: argocd-token
                    secret: ${ARGOCD_TOKEN}
                    description: ArgoCD API Token
