pipeline {
    agent any

    options {
        buildDiscarder(logRotator(numToKeepStr: '20', daysToKeepStr: '30'))
        timeout(time: 1, unit: 'HOURS')
        skipStagesAfterUnstable()
    }

    parameters {
        string(name: 'VERSION', defaultValue: '', description: 'Optional version override (defaults to <branch>-<build>).')
    }

    environment {
        APP_NAME = 'multi-env-app'
    }

    stages {
        stage('Initialize') {
            steps {
                script {
                    env.BRANCH_NAME = env.BRANCH_NAME ?: 'unknown'
                    env.BUILD_VERSION = params.VERSION?.trim() ? params.VERSION.trim() : "${env.BRANCH_NAME}-${env.BUILD_NUMBER}"
                    env.BUILD_LABEL = env.BUILD_VERSION.replaceAll(/[^A-Za-z0-9-]+/, '-').toLowerCase()
                    env.ARTIFACT_NAME = "${env.APP_NAME}-${env.BUILD_LABEL}.txt"
                    env.RELEASE_JOB_NAME = "release-build-${env.BUILD_LABEL}"

                    currentBuild.displayName = env.BUILD_VERSION
                    currentBuild.description = "Build for ${env.APP_NAME}"

                    echo "Initialized build ${env.BUILD_VERSION} on branch ${env.BRANCH_NAME}"
                }
            }
        }

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build') {
            steps {
                script {
                    echo "Simulating build for ${env.APP_NAME} ${env.BUILD_VERSION}"
                    sh '''#!/bin/bash
set -e
echo "Compiling sources..."
sleep 1
echo "Running tests..."
sleep 1
echo "Build successful."
'''
                }
            }
        }

        stage('Package') {
            steps {
                script {
                    def now = new Date().format('yyyy-MM-dd HH:mm:ss')
                    def artifactContent = """
Application : ${env.APP_NAME}
Version     : ${env.BUILD_VERSION}
Branch      : ${env.BRANCH_NAME}
Build       : ${env.BUILD_NUMBER}
Timestamp   : ${now}
""".stripIndent()

                    writeFile file: env.ARTIFACT_NAME, text: artifactContent

                    def buildInfo = [
                        application: env.APP_NAME,
                        branch     : env.BRANCH_NAME,
                        buildNumber: env.BUILD_NUMBER,
                        version    : env.BUILD_VERSION,
                        generated  : now
                    ]
                    def buildInfoJson = groovy.json.JsonOutput.prettyPrint(groovy.json.JsonOutput.toJson(buildInfo))
                    writeFile file: 'build-info.json', text: buildInfoJson

                    archiveArtifacts artifacts: "${env.ARTIFACT_NAME},build-info.json", fingerprint: true
                    echo "Packaged artifact ${env.ARTIFACT_NAME}"
                }
            }
        }

        stage('Create Release Job') {
            steps {
                script {
                    def releaseJobName = env.RELEASE_JOB_NAME
                    def sourceJob = env.JOB_NAME
                    def sourceBuild = env.BUILD_NUMBER
                    def versionTag = env.BUILD_VERSION

                    def dsl = """
pipelineJob('${releaseJobName}') {
    description('Deploy build ${versionTag} to any environment')
    displayName('${releaseJobName}')

    parameters {
        stringParam('SOURCE_JOB', '${sourceJob}', 'Job that produced this build')
        stringParam('SOURCE_BUILD', '${sourceBuild}', 'Build number containing the artifacts')
        stringParam('VERSION', '${versionTag}', 'Version to deploy')
        choiceParam('TARGET_ENVIRONMENT', ['dev', 'test', 'stage', 'prod'], 'Select the environment to deploy')
        textParam('DEPLOYMENT_NOTES', '', 'Optional deployment notes')
    }

    definition {
        cps {
            script('''
pipeline {
    agent any

    stages {
        stage('Fetch Artifacts') {
            steps {
                copyArtifacts(
                    projectName: params.SOURCE_JOB,
                    selector: specific(params.SOURCE_BUILD)
                )
                echo "Copied artifacts from ${params.SOURCE_JOB} #${params.SOURCE_BUILD}".toString()
            }
        }

        stage('Deploy') {
            steps {
                script {
                    if (params.TARGET_ENVIRONMENT == 'prod') {
                        def approval = input(
                            message: 'Production deployment approval required',
                            submitter: 'prod-approvers',
                            parameters: [
                                string(name: 'CHANGE_TICKET', description: 'Change ticket number'),
                                text(name: 'APPROVAL_NOTES', description: 'Approval notes')
                            ]
                        )
                        echo "Change Ticket: \${approval.CHANGE_TICKET}"
                        echo "Approval Notes: \${approval.APPROVAL_NOTES}"
                    }

                    def notes = params.DEPLOYMENT_NOTES?.trim() ? params.DEPLOYMENT_NOTES.trim() : 'N/A'
                    echo "Preparing deployment of ${params.VERSION} to ${params.TARGET_ENVIRONMENT}"
                    echo "Deployment notes: ${notes}"
                    sh "echo Deploying ${params.VERSION} to ${params.TARGET_ENVIRONMENT}"
                    sh "echo Deployment complete"

                    currentBuild.description = "${params.VERSION} ‚Üí ${params.TARGET_ENVIRONMENT}".toString()
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ \${params.VERSION} deployed to \${params.TARGET_ENVIRONMENT}"
        }
        failure {
            echo "‚ùå Deployment failed for \${params.VERSION} to \${params.TARGET_ENVIRONMENT}"
        }
    }
}
            ''')
            sandbox(true)
        }
    }
}
"""

                    jobDsl scriptText: dsl

                    echo "‚úÖ Release job created: ${releaseJobName}"
                    if (env.JENKINS_URL) {
                        echo "üîó ${env.JENKINS_URL}job/${releaseJobName}"
                    }

                    currentBuild.description = "Build ${versionTag} | Release job: ${releaseJobName}"
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ Build ${env.BUILD_VERSION} completed"
        }
        failure {
            echo "‚ùå Build ${env.BUILD_VERSION} failed"
        }
    }
}
